<ResourceDictionary
    x:Class="Photon.NINA.Skyflats.SkyflatsTestCategory.PluginItemTemplate"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="clr-namespace:Photon.NINA.Skyflats"
    xmlns:mini="clr-namespace:NINA.View.Sequencer.MiniSequencer;assembly=NINA.Sequencer"
    xmlns:nina="clr-namespace:NINA.View.Sequencer;assembly=NINA.Sequencer"
        xmlns:util="clr-namespace:NINA.Core.Utility;assembly=NINA.Core"
        xmlns:filter="clr-namespace:NINA.Core.Model;assembly=NINA.Core"

    xmlns:ninactrl="clr-namespace:NINA.CustomControlLibrary;assembly=NINA.CustomControlLibrary">
    <!--  This geometrygroup defines a custom SVG to be used with the plugin instruction  -->
    <GeometryGroup x:Key="Plugin_Skyflats_SVG">
        <!-- Sensor outline -->
        <PathGeometry Figures="M 0,0 L 200,0 L 200,150 L 0,150 Z" />

        <!-- Vignetting effect (concentric circles) -->
        <EllipseGeometry Center="100,75" RadiusX="95" RadiusY="70" />
        <EllipseGeometry Center="100,75" RadiusX="85" RadiusY="60" />
        <EllipseGeometry Center="100,75" RadiusX="75" RadiusY="50" />

        <!-- Dust donut -->
        <EllipseGeometry Center="50,40" RadiusX="5" RadiusY="5" />
        <EllipseGeometry Center="50,40" RadiusX="3" RadiusY="3" />
    </GeometryGroup>

    <WrapPanel
      x:Key="myTakeExposureDetails"
      x:Shared="false"
      Orientation="Horizontal">
        <TextBlock
          Margin="5,0,0,0"
          VerticalAlignment="Center"
          Text="Amount" />
        <TextBox
          MinWidth="40"
          Margin="5,0,0,0"
          VerticalAlignment="Center"
          Text="{Binding Conditions[0].Iterations}"
          TextAlignment="Right" />
        <TextBlock
          Margin="7.5,0,7.5,0"
          HorizontalAlignment="Center"
          VerticalAlignment="Center"
          Text="|" />

        <TextBlock VerticalAlignment="Center" Text="Filter" />

        <ComboBox
          Margin="5,0,0,0"
          DisplayMemberPath="Name"
          SelectedItem="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type nina:SequenceBlockView}}, Path=DataContext.Items[2].Filter, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource FilterWheelFilterConverter}}"
          SelectedValuePath="Name">
            <ComboBox.Resources>
                <CollectionViewSource x:Key="Filters" Source="{Binding Source={StaticResource ProfileService}, Path=ActiveProfile.FilterWheelSettings.FilterWheelFilters}" />
            </ComboBox.Resources>
            <ComboBox.ItemsSource>
                <CompositeCollection>
                    <x:Static Member="filter:NullFilter.Instance" />
                    <CollectionContainer Collection="{Binding Source={StaticResource Filters}}" />
                </CompositeCollection>
            </ComboBox.ItemsSource>
        </ComboBox>

        <StackPanel DataContext="{Binding Items[0]}" Orientation="Horizontal">
            <StackPanel.Resources>
                <util:BindingProxy x:Key="CameraInfo" Data="{Binding CameraInfo}" />
            </StackPanel.Resources>

            <TextBlock
              Margin="7.5,0,7.5,0"
              HorizontalAlignment="Center"
              VerticalAlignment="Center"
              Text="|" />

            <TextBlock VerticalAlignment="Center" Text="Binning" />
            <ComboBox
              Margin="5,0,0,0"
              DisplayMemberPath="Name"
              ItemsSource="{Binding Source={StaticResource CameraInfo}, Path=Data.BinningModes, Converter={StaticResource DefaultBinningModesConverter}}"
              SelectedItem="{Binding Binning, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
              SelectedValuePath="Name" />

            <!--  List of Gain  -->
            <WrapPanel Orientation="Horizontal">
                <WrapPanel.Visibility>
                    <PriorityBinding>
                        <Binding
                          Converter="{StaticResource CollectionContainsItemsToVisibilityConverter}"
                          Path="Data.Gains"
                          Source="{StaticResource CameraInfo}" />
                        <Binding
                          Converter="{StaticResource BooleanToVisibilityCollapsedConverter}"
                          Path="Data.Connected"
                          Source="{StaticResource CameraInfo}" />
                    </PriorityBinding>
                </WrapPanel.Visibility>
                <TextBlock
                  Margin="7.5,0,7.5,0"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Text="|" />
                <TextBlock VerticalAlignment="Center" Text="Gain" />
                <ComboBox
                  Margin="5,0,0,0"
                  DisplayMemberPath="Text"
                  IsSynchronizedWithCurrentItem="True"
                  SelectedValuePath="Text">
                    <ComboBox.ItemsSource>
                        <CompositeCollection>
                            <TextBlock Text="{Binding Source={StaticResource CameraInfo}, Path=Data.DefaultGain, UpdateSourceTrigger=PropertyChanged, StringFormat=({0})}" />
                            <CollectionContainer Collection="{Binding Source={StaticResource CameraInfo}, Path=Data.Gains, Converter={StaticResource IntListToTextBlockListConverter}}" />
                        </CompositeCollection>
                    </ComboBox.ItemsSource>
                    <ComboBox.SelectedValue>
                        <MultiBinding
                          Converter="{StaticResource MinusOneToBaseValueConverter}"
                          Mode="TwoWay"
                          UpdateSourceTrigger="PropertyChanged">
                            <Binding
                              Mode="TwoWay"
                              Path="Gain"
                              UpdateSourceTrigger="PropertyChanged" />
                            <Binding
                              Mode="OneWay"
                              Path="Data.DefaultGain"
                              Source="{StaticResource CameraInfo}"
                              UpdateSourceTrigger="PropertyChanged" />
                        </MultiBinding>
                    </ComboBox.SelectedValue>
                </ComboBox>
            </WrapPanel>

            <!--  Free Gain  -->
            <WrapPanel Orientation="Horizontal">
                <WrapPanel.Visibility>
                    <PriorityBinding FallbackValue="Visible">
                        <Binding
                          Converter="{StaticResource InverseCollectionContainsItemsToVisibilityConverter}"
                          Path="Data.Gains"
                          Source="{StaticResource CameraInfo}" />
                    </PriorityBinding>
                </WrapPanel.Visibility>
                <TextBlock
                  Margin="7.5,0,7.5,0"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Text="|" />
                <TextBlock VerticalAlignment="Center" Text="Gain" />
                <ninactrl:HintTextBox
                  MinWidth="40"
                  Margin="5,0,0,0"
                  VerticalAlignment="Center"
                  HorizontalContentAlignment="Right"
                  VerticalContentAlignment="Center"
                  Foreground="{StaticResource PrimaryBrush}"
                  TextAlignment="Right">
                    <ninactrl:HintTextBox.HintText>
                        <Binding
                          Converter="{StaticResource CameraDefaultValueConverter}"
                          Mode="OneWay"
                          Path="Data.DefaultGain"
                          Source="{StaticResource CameraInfo}"
                          UpdateSourceTrigger="PropertyChanged" />
                    </ninactrl:HintTextBox.HintText>
                    <ninactrl:HintTextBox.Text>
                        <Binding
                          Converter="{StaticResource MinusOneToEmptyStringConverter}"
                          Mode="TwoWay"
                          Path="Gain"
                          UpdateSourceTrigger="PropertyChanged">
                            <Binding.ValidationRules>
                                <util:ShortRangeRule>
                                    <util:ShortRangeRule.ValidRange>
                                        <util:ShortRangeChecker Maximum="32767" Minimum="-1" />
                                    </util:ShortRangeRule.ValidRange>
                                </util:ShortRangeRule>
                            </Binding.ValidationRules>
                        </Binding>
                    </ninactrl:HintTextBox.Text>
                </ninactrl:HintTextBox>
            </WrapPanel>

            <!--  Offset  -->
            <WrapPanel Orientation="Horizontal">
                <WrapPanel.Visibility>
                    <MultiBinding Converter="{StaticResource BooleanOrToVisibilityCollapsedMultiConverter}" FallbackValue="Visible">
                        <Binding
                          Converter="{StaticResource InverseBooleanConverter}"
                          Path="Data.Connected"
                          Source="{StaticResource CameraInfo}" />
                        <Binding Path="Data.CanSetOffset" Source="{StaticResource CameraInfo}" />
                    </MultiBinding>
                </WrapPanel.Visibility>
                <TextBlock
                  Margin="7.5,0,7.5,0"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Text="|" />
                <TextBlock VerticalAlignment="Center" Text="Offset" />
                <ninactrl:HintTextBox
                  MinWidth="40"
                  Margin="5,0,0,0"
                  VerticalAlignment="Center"
                  HorizontalContentAlignment="Right"
                  VerticalContentAlignment="Center"
                  Foreground="{StaticResource PrimaryBrush}"
                  TextAlignment="Right">
                    <ninactrl:HintTextBox.HintText>
                        <Binding
                          Converter="{StaticResource CameraDefaultValueConverter}"
                          Mode="OneWay"
                          Path="Data.DefaultOffset"
                          Source="{StaticResource CameraInfo}"
                          UpdateSourceTrigger="PropertyChanged" />
                    </ninactrl:HintTextBox.HintText>
                    <ninactrl:HintTextBox.Text>
                        <Binding
                          Converter="{StaticResource MinusOneToEmptyStringConverter}"
                          Mode="TwoWay"
                          Path="Offset"
                          UpdateSourceTrigger="PropertyChanged">
                            <Binding.ValidationRules>
                                <util:ShortRangeRule>
                                    <util:ShortRangeRule.ValidRange>
                                        <util:ShortRangeChecker Maximum="32767" Minimum="-1" />
                                    </util:ShortRangeRule.ValidRange>
                                </util:ShortRangeRule>
                            </Binding.ValidationRules>
                        </Binding>
                    </ninactrl:HintTextBox.Text>
                </ninactrl:HintTextBox>
            </WrapPanel>
        </StackPanel>
    </WrapPanel>

    <!--  The definition of the plugin test instruction style  -->
    <!--  The DataType has to be defined as the instruction in context  -->
    <DataTemplate DataType="{x:Type local:TakeSkyFlats}">
        <nina:SequenceBlockView>
            <nina:SequenceBlockView.SequenceItemContent>

                <StackPanel Orientation="Vertical">
                    <WrapPanel Orientation="Horizontal">

                        <TextBlock
                          Margin="5,0,0,0"

                          VerticalAlignment="Center"
                          Text="SQM" />
                        <ninactrl:UnitTextBox
                         MinWidth="40"
                         Margin="5,0,0,0"
                         VerticalAlignment="Center"
                         Text="{Binding SQMStart}"
                         TextAlignment="Right" />

                        <TextBlock
                          Margin="5,0,0,0"
                          VerticalAlignment="Center"
                          Text="-" />

                        <ninactrl:UnitTextBox
                          MinWidth="40"
                          Margin="5,0,0,0"
                          VerticalAlignment="Center"
                          Text="{Binding SQMEnd}"
                          TextAlignment="Right"
                          Unit="mag/arcsec²" />
                        <TextBlock
                           Margin="7.5,0,7.5,0"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"
                           Text="|" />

                        <TextBlock
                            Margin="5,0,0,0"
                            VerticalAlignment="Center"
                            Text="Exposure " />
                        <ninactrl:UnitTextBox
                            MinWidth="40"
                            Margin="5,0,0,0"
                            VerticalAlignment="Center"
                            Text="{Binding MinExposure}"
                            TextAlignment="Right"
                            Unit="s" />

                        <TextBlock
                          Margin="5,0,0,0"
                          VerticalAlignment="Center"
                          Text="-" />

                        <ninactrl:UnitTextBox
                            MinWidth="40"
                            Margin="5,0,0,0"
                            VerticalAlignment="Center"
                            Text="{Binding MaxExposure}"
                            TextAlignment="Right"
                            Unit="s" />
                        <TextBlock
                            Margin="7.5,0,7.5,0"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Text="|" />

                        <TextBlock
                            Margin="5,0,0,0"
                            VerticalAlignment="Center"
                            Text="Histogram mean target" />
                        <ninactrl:UnitTextBox
                            MinWidth="40"
                            Margin="5,0,0,0"
                            VerticalAlignment="Center"
                            Text="{Binding HistogramTargetPercentage, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource PercentageConverter}}"
                            TextAlignment="Right"
                            Unit="%" />
                        <TextBlock
                            Margin="7.5,0,7.5,0"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Text="|" />

                        <TextBlock
                            Margin="5,0,0,0"
                            VerticalAlignment="Center"
                            Text="Mean tolerance" />
                        <ninactrl:UnitTextBox
                            MinWidth="40"
                            Margin="5,0,0,0"
                            VerticalAlignment="Center"
                            Text="{Binding HistogramTolerancePercentage, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource PercentageConverter}}"
                            TextAlignment="Right"
                            Unit="%" />
                    </WrapPanel>

                    <ContentPresenter Content="{StaticResource myTakeExposureDetails}" DataContext="{Binding ImagingContainer}" />
                </StackPanel>
            </nina:SequenceBlockView.SequenceItemContent>
            <nina:SequenceBlockView.SequenceItemProgressContent>
                <WrapPanel DataContext="{Binding ImagingContainer}" Orientation="Horizontal">
                    <TextBlock VerticalAlignment="Center" Text="Progress" />
                    <TextBlock
                        Margin="5,0,0,0"
                        VerticalAlignment="Center"
                        Text="{Binding Conditions[0].CompletedIterations}" />
                    <TextBlock VerticalAlignment="Center" Text="/" />
                    <TextBlock VerticalAlignment="Center" Text="{Binding Conditions[0].Iterations}" />
                </WrapPanel>
            </nina:SequenceBlockView.SequenceItemProgressContent>
        </nina:SequenceBlockView>
    </DataTemplate>

    <!--  The definition of the plugin test instruction style  -->
    <!--  The DataType has to be defined as the instruction in context  -->
    <DataTemplate DataType="{x:Type local:SlewToNullPoint}">
        <nina:SequenceBlockView>
            <nina:SequenceBlockView.SequenceItemContent>
                <StackPanel Orientation="Horizontal">
                </StackPanel>
            </nina:SequenceBlockView.SequenceItemContent>
        </nina:SequenceBlockView>
    </DataTemplate>

    <!--  The definition of the test instruction plugin style in the mini format on the imaging tab  -->
    <!--  The Key has to be defined as the fully qualified instruction name and the "_Mini" postfix  -->
    <DataTemplate x:Key="Photon.NINA.Skyflats.SkyflatsTestCategory.SkyflatsInstruction_Mini">
        <mini:MiniSequenceItem>
            <mini:MiniSequenceItem.SequenceItemContent>
                <StackPanel Orientation="Horizontal">
                </StackPanel>
            </mini:MiniSequenceItem.SequenceItemContent>
        </mini:MiniSequenceItem>
    </DataTemplate>

    <!--  The definition of the plugin test condition style  -->
    <!--  The DataType has to be defined as the instruction in context  -->
    <DataTemplate DataType="{x:Type local:SkyflatsCondition}">
        <nina:SequenceBlockView>
            <nina:SequenceBlockView.SequenceItemContent>
                <StackPanel Orientation="Horizontal">
                    <ComboBox
                        MinWidth="100"
                        SelectedItem="{Binding SQMOperator}"
                        ItemsSource="{Binding SQMoperators}" />
                    <TextBox
                        MinWidth="40"
                        Margin="5,0,0,0"
                        Text="{Binding SQMThreshold}"
                        TextAlignment="Right" />
                    <ninactrl:UnitTextBox
                        MinWidth="60"
                        Margin="10,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"

                        Unit="mag/arcsec²">
                    </ninactrl:UnitTextBox>
                </StackPanel>
            </nina:SequenceBlockView.SequenceItemContent>
        </nina:SequenceBlockView>
    </DataTemplate>

    <DataTemplate DataType="{x:Type local:WaitUntilSQM}">
        <nina:SequenceBlockView>
            <nina:SequenceBlockView.SequenceItemContent>
                <StackPanel Orientation="Horizontal">
                    <ComboBox
                     MinWidth="100"
                     SelectedItem="{Binding SQMOperator}"
                     ItemsSource="{Binding SQMoperators}" />
                    <TextBox
                     MinWidth="40"
                     Margin="5,0,0,0"
                     Text="{Binding SQMThreshold}"
                     TextAlignment="Right" />
                    <ninactrl:UnitTextBox
                     MinWidth="60"
                     Margin="10,0,0,0"
                     HorizontalAlignment="Left"
                     VerticalAlignment="Center"

                     Unit="mag/arcsec²">
                    </ninactrl:UnitTextBox>
                </StackPanel>
            </nina:SequenceBlockView.SequenceItemContent>
        </nina:SequenceBlockView>
    </DataTemplate>

    <!--  The definition of the test condition plugin style in the mini format on the imaging tab  -->
    <!--  The Key has to be defined as the fully qualified instruction name and the "_Mini" postfix  -->
    <DataTemplate x:Key="Photon.NINA.Skyflats.SkyflatsTestCategory.SkyflatsCondition_Mini">
        <mini:MiniSequenceItem>
            <mini:MiniSequenceItem.SequenceItemContent>
                <StackPanel Orientation="Horizontal">
                </StackPanel>
            </mini:MiniSequenceItem.SequenceItemContent>
        </mini:MiniSequenceItem>
    </DataTemplate>
</ResourceDictionary>