<ResourceDictionary
    x:Class="Photon.NINA.Skyflats.Options"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
     xmlns:ninactrl="clr-namespace:NINA.CustomControlLibrary;assembly=NINA.CustomControlLibrary"
        xmlns:util="clr-namespace:NINA.Core.Utility;assembly=NINA.Core"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    <!--  This data template will be displayed in N.I.N.A. on the options->plugin tab with the datacontext of the TestPlugin instance  -->
    <!--  In order for this datatemplate to be picked correctly, the key has to follow the naming convention of <IPlugin.Name>_Options -->
    <!--  Furthermore the Resource Dictionary has to be exported via code behind export attributes  -->

    <DataTemplate x:Key="SkyFlats_Options">
        <StackPanel Orientation="Vertical" Margin="0,8">
            <!-- Null Point Settings Group -->

            <StackPanel Orientation="Vertical" Margin="0,0,0,12">

                <TextBlock Text="Null Point" FontSize="16" FontWeight="Bold" Margin="0,0,0,6" />

                <TextBlock FontSize="10"
                    Text="The null point is a specific position in the sky where the polarization of twilight sky background is minimized. This occurs approximately 90 degrees from the Sun, where sky brightness is more uniform. Taking flat fields at this null point position reduces polarization effects that can create systematic errors in flat field calibration, resulting in more accurate and consistent flat fields."
            TextWrapping="Wrap" />

                <StackPanel Orientation="Horizontal" Margin="16,4">

                    <TextBlock Text="Re-slew to Null point while taking Sky Flats"
                          Margin="8,0,0,0" VerticalAlignment="Center" MinWidth="250" />
                    <CheckBox IsChecked="{Binding ReslewToNullPoint}" VerticalAlignment="Center" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="36,4">
                    <TextBlock Text="every" VerticalAlignment="Center" />
                    <TextBox Width="40" Text="{Binding ReslewEverySeconds}"
                        Margin="8,0,8,0" VerticalAlignment="Center" />
                    <TextBlock Text="seconds" VerticalAlignment="Center" />
                </StackPanel>
            </StackPanel>

            <!-- Dithering Settings Group -->
            <StackPanel Orientation="Vertical">
                <TextBlock Text="Dithering" FontWeight="Bold" FontSize="16" Margin="0,0,0,6" />
                <TextBlock FontSize="10"
                    Text="Dithering involves making small, random offsets to the telescope pointing between exposures. During sky flats acquisition (which occurs during twilight), dithering is essential to prevent stars from accumulating in fixed positions across multiple frames. This technique ensures that any stellar remnants or fixed-pattern noise are averaged out during the stacking process, resulting in cleaner, more accurate flat fields. Dithering is particularly important when taking flats closer to darkness when more stars become visible."
                           TextWrapping="Wrap" />

                <StackPanel Orientation="Horizontal" Margin="16,4">

                    <TextBlock Text="Use Dithering while taking Sky Flats"
                          Margin="8,0,0,0" VerticalAlignment="Center" MinWidth="250" />
                    <CheckBox IsChecked="{Binding UseDithering}" VerticalAlignment="Center" />
                </StackPanel>

                <Grid Margin="36,8,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <TextBlock Text="Dither amount:" VerticalAlignment="Center" Grid.Row="0" Grid.Column="0" />
                    <TextBox Width="40" Text="{Binding DitherArcsec}" Margin="8,0,8,0"
                        VerticalAlignment="Center" Grid.Row="0" Grid.Column="1" />
                    <TextBlock Text="pixels" VerticalAlignment="Center" Grid.Row="0" Grid.Column="2" />

                    <TextBlock Text="Settle time:" VerticalAlignment="Center" Grid.Row="1" Grid.Column="0" Margin="0,8,0,0" />
                    <TextBox Width="40" Text="{Binding DitherSettleTime}" Margin="8,0,8,0"
                        VerticalAlignment="Center" Grid.Row="1" Grid.Column="1" />
                    <TextBlock Text="seconds" VerticalAlignment="Center" Grid.Row="1" Grid.Column="2" Margin="0,8,0,0" />
                </Grid>
            </StackPanel>

            <StackPanel Orientation="Vertical">
                <StackPanel.Resources>
                    <util:BindingProxy x:Key="CameraInfo" Data="{Binding CameraInfo}" />
                    <util:BindingProxy x:Key="FocuserInfo" Data="{Binding DeviceConsumer.FocuserInfo}" />
                    <util:BindingProxy x:Key="DataContext" Data="{Binding}" />
                </StackPanel.Resources>
                <GroupBox
                Grid.Row="1"
                DataContext="{Binding FilterWheelSettings}"
                Header="Filter settings">
                    <StackPanel>
                        <DataGrid
                        MaxHeight="300"
                        AutoGenerateColumns="False"
                        CanUserAddRows="False"
                        HeadersVisibility="Column"
                        HorizontalScrollBarVisibility="Disabled"
                        ItemsSource="{Binding FilterWheelFilters}"
                        SelectedItem="{Binding DataContext.SelectedFilter, ElementName=UC}"
                        SelectionMode="Single"
                        VerticalScrollBarVisibility="Auto">
                            <DataGrid.Columns>
                                <DataGridTemplateColumn
                                Width="*"
                                CanUserSort="False"
                                Header="Position">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock
                                            Margin="5,0,5,0"
                                            VerticalAlignment="Center"
                                            Text="{Binding Position, Converter={StaticResource AddToNumberConverter}, ConverterParameter=1}"
                                            TextAlignment="Center" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn
                                Width="*"
                                CanUserSort="False"
                                Header="Name">
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <TextBox
                                            Margin="5,0,5,0"
                                            VerticalAlignment="Center"
                                            Text="{Binding Name}"
                                            TextAlignment="Center" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock
                                            Margin="5,0,5,0"
                                            VerticalAlignment="Center"
                                            Text="{Binding Name}"
                                            TextAlignment="Center" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn
                                Width="*"
                                CanUserSort="False"
                                Header="Filter Constant">
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <TextBox
                                            Margin="5,0,5,0"
                                            VerticalAlignment="Center"
                                            Text="{Binding FocusOffset}"
                                            TextAlignment="Center" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock
                                            Margin="5,0,5,0"
                                            VerticalAlignment="Center"
                                            Text="{Binding FocusOffset}"
                                            TextAlignment="Center" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <DataGridTemplateColumn
                                Width="*"
                                CanUserSort="False"
                                Header="Active?"
                                Visibility="{Binding ActiveProfile.FocuserSettings.UseFilterWheelOffsets, Source={StaticResource ProfileService}, Converter={StaticResource BooleanToVisibilityCollapsedConverter}}">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <CheckBox
                                            Width="20"
                                            Height="20"
                                            Margin="5,0,0,0"
                                            HorizontalAlignment="Center"
                                            BorderBrush="Transparent"
                                            IsChecked="{Binding AutoFocusFilter, FallbackValue=False, Mode=OneWay}"
                                            IsEnabled="False"
                                            Style="{StaticResource CheckmarkCheckbox}"
                                            Visibility="{Binding AutoFocusFilter, Converter={StaticResource VisibilityConverter}}" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn
                                Width="*"
                                CanUserSort="False"
                                Header="Binning">
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <ComboBox
                                            DisplayMemberPath="Name"
                                            ItemsSource="{Binding Source={StaticResource CameraInfo}, Path=Data.BinningModes, Converter={StaticResource DefaultBinningModesConverter}}"
                                            SelectedItem="{Binding AutoFocusBinning, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                            SelectedValuePath="Name" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock
                                            Margin="5,0,5,0"
                                            VerticalAlignment="Center"
                                            Text="{Binding AutoFocusBinning}"
                                            TextAlignment="Center" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <!--  List of ISOs  -->
                                <DataGridTemplateColumn
                                Width="*"
                                CanUserSort="False"
                                Header="Gain">
                                    <DataGridTemplateColumn.Visibility>
                                        <PriorityBinding>
                                            <Binding
                                            Converter="{StaticResource CollectionContainsItemsToVisibilityConverter}"
                                            Path="Data.Gains"
                                            Source="{StaticResource CameraInfo}" />
                                            <Binding
                                            Converter="{StaticResource BooleanToVisibilityCollapsedConverter}"
                                            Path="Data.Connected"
                                            Source="{StaticResource CameraInfo}" />
                                        </PriorityBinding>
                                    </DataGridTemplateColumn.Visibility>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <ComboBox
                                            Grid.Column="1"
                                            DisplayMemberPath="Text"
                                            IsSynchronizedWithCurrentItem="True"
                                            SelectedValuePath="Text">
                                                <ComboBox.ItemsSource>
                                                    <CompositeCollection>
                                                        <TextBlock Text="{Binding Source={StaticResource CameraInfo}, Path=Data.DefaultGain, UpdateSourceTrigger=PropertyChanged, StringFormat=({0})}" />
                                                        <CollectionContainer Collection="{Binding Source={StaticResource CameraInfo}, Path=Data.Gains, Converter={StaticResource IntListToTextBlockListConverter}}" />
                                                    </CompositeCollection>
                                                </ComboBox.ItemsSource>
                                                <ComboBox.SelectedValue>
                                                    <MultiBinding
                                                    Converter="{StaticResource MinusOneToBaseValueConverter}"
                                                    Mode="TwoWay"
                                                    UpdateSourceTrigger="PropertyChanged">
                                                        <Binding
                                                        Mode="TwoWay"
                                                        Path="AutoFocusGain"
                                                        UpdateSourceTrigger="PropertyChanged" />
                                                        <Binding
                                                        Mode="OneWay"
                                                        Path="Data.DefaultGain"
                                                        Source="{StaticResource CameraInfo}"
                                                        UpdateSourceTrigger="PropertyChanged" />
                                                    </MultiBinding>
                                                </ComboBox.SelectedValue>
                                            </ComboBox>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock
                                            Margin="5,0,5,0"
                                            VerticalAlignment="Center"
                                            TextAlignment="Center">
                                                <TextBlock.Text>
                                                    <MultiBinding Converter="{StaticResource MinusOneToBaseValueConverter}" UpdateSourceTrigger="LostFocus">
                                                        <Binding
                                                        Mode="TwoWay"
                                                        Path="AutoFocusGain"
                                                        UpdateSourceTrigger="PropertyChanged" />
                                                        <Binding
                                                        Mode="OneWay"
                                                        Path="Data.DefaultGain"
                                                        Source="{StaticResource CameraInfo}"
                                                        UpdateSourceTrigger="PropertyChanged" />
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!--  Free Gain Setting  -->
                                <DataGridTemplateColumn
                                Width="*"
                                CanUserSort="False"
                                Header="Gain">
                                    <DataGridTemplateColumn.Visibility>
                                        <PriorityBinding FallbackValue="Visible">
                                            <Binding
                                            Converter="{StaticResource InverseCollectionContainsItemsToVisibilityConverter}"
                                            Path="Data.Gains"
                                            Source="{StaticResource CameraInfo}" />
                                        </PriorityBinding>
                                    </DataGridTemplateColumn.Visibility>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <ninactrl:HintTextBox
                                            MinWidth="40"
                                            Margin="5,0,5,0"
                                            VerticalAlignment="Center"
                                            HorizontalContentAlignment="Center"
                                            VerticalContentAlignment="Center"
                                            Foreground="{StaticResource PrimaryBrush}"
                                            TextAlignment="Center">
                                                <ninactrl:HintTextBox.HintText>
                                                    <Binding
                                                    Converter="{StaticResource CameraDefaultValueConverter}"
                                                    Mode="OneWay"
                                                    Path="Data.DefaultGain"
                                                    Source="{StaticResource CameraInfo}"
                                                    UpdateSourceTrigger="PropertyChanged" />
                                                </ninactrl:HintTextBox.HintText>
                                                <ninactrl:HintTextBox.Text>
                                                    <Binding
                                                    Converter="{StaticResource MinusOneToEmptyStringConverter}"
                                                    Mode="TwoWay"
                                                    Path="AutoFocusGain"
                                                    UpdateSourceTrigger="LostFocus">
                                                        <Binding.ValidationRules>
                                                            <util:ShortRangeRule>
                                                                <util:ShortRangeRule.ValidRange>
                                                                    <util:ShortRangeChecker Maximum="32767" Minimum="-1" />
                                                                </util:ShortRangeRule.ValidRange>
                                                            </util:ShortRangeRule>
                                                        </Binding.ValidationRules>
                                                    </Binding>
                                                </ninactrl:HintTextBox.Text>
                                            </ninactrl:HintTextBox>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock
                                            Margin="5,0,5,0"
                                            VerticalAlignment="Center"
                                            TextAlignment="Center">
                                                <TextBlock.Text>
                                                    <MultiBinding Converter="{StaticResource MinusOneToBaseValueConverter}" UpdateSourceTrigger="LostFocus">
                                                        <Binding
                                                        Mode="TwoWay"
                                                        Path="AutoFocusGain"
                                                        UpdateSourceTrigger="PropertyChanged" />
                                                        <Binding
                                                        Mode="OneWay"
                                                        Path="Data.DefaultGain"
                                                        Source="{StaticResource CameraInfo}"
                                                        UpdateSourceTrigger="PropertyChanged" />
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                                <!--  Free Offset Setting  -->
                                <DataGridTemplateColumn
                                Width="*"
                                CanUserSort="False"
                                Header="Offset">
                                    <DataGridTemplateColumn.Visibility>
                                        <MultiBinding Converter="{StaticResource BooleanOrToVisibilityCollapsedMultiConverter}" FallbackValue="Visible">
                                            <Binding
                                            Converter="{StaticResource InverseBooleanConverter}"
                                            Path="Data.Connected"
                                            Source="{StaticResource CameraInfo}" />
                                            <Binding Path="Data.CanSetOffset" Source="{StaticResource CameraInfo}" />
                                        </MultiBinding>
                                    </DataGridTemplateColumn.Visibility>
                                    <DataGridTemplateColumn.CellEditingTemplate>
                                        <DataTemplate>
                                            <ninactrl:HintTextBox
                                            MinWidth="40"
                                            Margin="5,0,5,0"
                                            VerticalAlignment="Center"
                                            HorizontalContentAlignment="Center"
                                            VerticalContentAlignment="Center"
                                            Foreground="{StaticResource PrimaryBrush}"
                                            TextAlignment="Center">
                                                <ninactrl:HintTextBox.HintText>
                                                    <Binding
                                                    Converter="{StaticResource CameraDefaultValueConverter}"
                                                    Mode="OneWay"
                                                    Path="Data.DefaultOffset"
                                                    Source="{StaticResource CameraInfo}"
                                                    UpdateSourceTrigger="PropertyChanged" />
                                                </ninactrl:HintTextBox.HintText>
                                                <ninactrl:HintTextBox.Text>
                                                    <Binding
                                                    Converter="{StaticResource MinusOneToEmptyStringConverter}"
                                                    Mode="TwoWay"
                                                    Path="AutoFocusOffset"
                                                    UpdateSourceTrigger="LostFocus">
                                                        <Binding.ValidationRules>
                                                            <util:ShortRangeRule>
                                                                <util:ShortRangeRule.ValidRange>
                                                                    <util:ShortRangeChecker Maximum="32767" Minimum="-1" />
                                                                </util:ShortRangeRule.ValidRange>
                                                            </util:ShortRangeRule>
                                                        </Binding.ValidationRules>
                                                    </Binding>
                                                </ninactrl:HintTextBox.Text>
                                            </ninactrl:HintTextBox>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellEditingTemplate>
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock
                                            Margin="5,0,5,0"
                                            VerticalAlignment="Center"
                                            TextAlignment="Center">
                                                <TextBlock.Text>
                                                    <MultiBinding Converter="{StaticResource MinusOneToBaseValueConverter}" UpdateSourceTrigger="LostFocus">
                                                        <Binding
                                                        Mode="TwoWay"
                                                        Path="AutoFocusOffset"
                                                        UpdateSourceTrigger="PropertyChanged" />
                                                        <Binding
                                                        Mode="OneWay"
                                                        Path="Data.DefaultOffset"
                                                        Source="{StaticResource CameraInfo}"
                                                        UpdateSourceTrigger="PropertyChanged" />
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                        <Button
                        Grid.Column="2"
                        Width="200"
                        Height="50"
                        Margin="5"
                        Command="{Binding Path=DataContext.SetAutoFocusFilterCommand, ElementName=UC}"
                        Visibility="{Binding ActiveProfile.FocuserSettings.UseFilterWheelOffsets, Source={StaticResource ProfileService}, Converter={StaticResource BooleanToVisibilityCollapsedConverter}}">
                            <Button.Content>
                                <TextBlock Foreground="{StaticResource ButtonForegroundBrush}" Text="hmmm" />
                            </Button.Content>
                            <Button.ToolTip>
                                <TextBlock Text="hä?" />
                            </Button.ToolTip>
                        </Button>
                    </StackPanel>
                </GroupBox>
            </StackPanel>
        </StackPanel>
    </DataTemplate>
</ResourceDictionary>